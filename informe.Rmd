---
title: "Aplicacion de vacunas COVID19 en Argentina - NOMIVAC: 2020-2023"
author: "Lautaro Felipe Skubaletzky"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    collapsed: true
    number_sections: true
    code_download: true
    css: hoja_estilo_tpfinal.css
    code_folding: hide 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# Cargar los paquetes necesarios acá
library(rmarkdown)
library(readr)
library(dplyr)
library(ggplot2)
library(stringr)
library(tidyr)
library(tidyverse)
library(stringr)
#library(readxl)
library(ggwordcloud)
library(janitor)
library(glue) ## para funciones tipo macro local de stata. forma sencilla de concatenar y formatear cadenas de texto en R. Puedes utilizar placeholders {} en una cadena de texto y luego usar la función glue() para reemplazar esos placeholders
library(lubridate)
```

```{r importa_datos, echo=TRUE}
file_path <- "datos/datos_nomivac_covid19.csv"
data <- read_csv(file_path, n_max = 100, show_col_types = FALSE)
obs_filas <- nrow(data)
```
:::{.alert .alert-warning}
Reporte parcial: Se cargan `r obs_filas` observaciones.
:::

# Exploración de los datos

:::{.alert .alert-info}
Esta sección es una primera exploracion de los datos. 

1.1. Estructura de datos
1.1. Intervalo de fechas del registro
1.1. Rango y magnitud de la base

2.1. Descripcion de variables de interés
2.1. Dominio de las variables (valores únicos)
2.1. Normalizacion de valores
2.1. Valores medios, minimos, maximos, cantidad de observaciones y participaciones sobre el total
:::

## Estructura de los datos

### Intervalo temporal del registro (primer y último)
```{r fechas_intervalo}
fecha_0 <- summarise(data, min(fecha_aplicacion))
fecha_T <- summarise(data, max(fecha_aplicacion))
```
La primer observacion se registró el **`r fecha_0`** y la última se registró el **`r fecha_T`**.

### Rango de los datos (cantidad de observaciones y variables)
```{r rango_datos}
obs_filas <- nrow(data) # cantidad de observaciones (filas)
obs_cols <- ncol(data) # cantidad de variables (columnas)
obs_valores = obs_filas * obs_cols # cantidad de datos (celdas)
```
Los datos se estructuran en **`r obs_filas`** observaciones (filas) y **`r obs_cols`** variables (columnas). Tenemos un total de **`r obs_valores`** valores o celdas con datos.

## Descripción de variables

### Exploración de dominio (valores únicos en cada variable)

A continuación se muestran los posibles valores que adoptan las variables, es decir su dominio, en términos del "estado de la variable".
```{r summary_data_levels_factor, echo=TRUE, include=TRUE, eval=TRUE}
summary(data)

varlist <- c("sexo","grupo_etario","condicion_aplicacion","vacuna", "nombre_dosis_generica", "orden_dosis")
for (vardin in varlist){
  var_output <- data[[vardin]]
  print(levels(factor(var_output)))
  }
```
Breve descripción del tipo de datos disponibles en NOMIVAC. La gran mayoría son character, excepcion de fecha y orden dosis, así como  variables id_codigos asociadas a otras descripcion_codigos.

### Corrección de datos (normalización y homogeneización)

```{r normalizacion_valores, echo=TRUE, eval=TRUE, include=FALSE}
source("scripts/normalizacion-variables-valores.R", local = TRUE, echo = TRUE)
```

### Descriptivas de variables de interés: valores medios, minimos, maximos, cantidades y participaciones
Obtengo algunos df sobre las cantidades y participación de la población objetivo de la vacunación desde diferentes perspectivas como son el `sexo`, `grupo_etario`, `condicion_aplicacion` y otras.

Adicionalmente se obtienen las medias de vacunación para cada grupo y mediante otros análisis puede comprobarse sí estas medias son estadísticamente diferentes.  [link.](https://openstax.org/books/introducci%C3%B3n-estad%C3%ADstica-empresarial/pages/10-1-comparacion-de-las-medias-de-dos-poblaciones-independientes)

##### By_sexo: Minimo, promedio, maximo, poblacion (n) y participacion (n_relativo) de dosis aplicadas
```{r sexo_min_mean_max_n_nrel}

# data_frame_valores_by_sexo
data %>% 
  group_by(id_persona) %>% 
  filter(fecha_aplicacion == max(fecha_aplicacion)) %>% 
  group_by(sexo) %>% 
  summarise(min_dosis = min(orden_dosis), 
            mean_dosis = mean(orden_dosis), 
            max_dosis = max(orden_dosis),
            n_grupo = length(orden_dosis),
            total_dosis = mean_dosis * n_grupo) %>% 
mutate(n_relativo = n_grupo / sum(n_grupo) * 100 )  %>%
arrange(desc(n_grupo))

# fecha de corte
fecha_i <- summarise(data, max(fecha_aplicacion))

# mas_abs: en absoluto recibió más vacunas
mas_abs <- data %>% 
  group_by(id_persona) %>% 
  filter(fecha_aplicacion == max(fecha_aplicacion)) %>% 
  group_by(sexo) %>% 
  summarise(n_grupo = sum(orden_dosis))
mas_abs <- mas_abs %>% 
  filter(n_grupo == max(n_grupo)) %>% 
  select(sexo)

# mas_rel: en promedio recibió más vacunas
mas_rel <- data %>% 
  group_by(id_persona) %>% 
  filter(fecha_aplicacion == max(fecha_aplicacion)) %>% 
  group_by(sexo) %>% 
  summarise(n_grupo = mean(orden_dosis))
mas_rel <- mas_rel %>% 
  filter(n_grupo == max(n_grupo)) %>% 
  select(sexo)

```
En la base, con fecha de corte hasta `r fecha_i` la población `r mas_abs` recibió mas vacunas en valor absoluto y `r mas_rel` en promedio.

##### By_grupo_etario: Minimo, promedio, maximo, poblacion (n) y participacion (n_relativo) de dosis aplicadas
```{r edad_min_mean_max_n_nrel}

# data_frame_valores_by_grupo_etario
data %>% 
  group_by(id_persona) %>% 
  filter(fecha_aplicacion == max(fecha_aplicacion)) %>% 
  group_by(grupo_etario) %>% 
  summarise(min_dosis = min(orden_dosis), 
            mean_dosis = mean(orden_dosis), 
            max_dosis = max(orden_dosis),
            n_grupo = length(orden_dosis),
            total_dosis = mean_dosis * n_grupo) %>% 
mutate(n_relativo = n_grupo / sum(n_grupo) * 100 )  %>%
arrange(desc(n_grupo))

# fecha de corte
fecha_i <- summarise(data, max(fecha_aplicacion))

# mas_abs: en absoluto recibió más vacunas
mas_abs <- data %>% 
  group_by(id_persona) %>% 
  filter(fecha_aplicacion == max(fecha_aplicacion)) %>% 
  group_by(grupo_etario) %>% 
  summarise(n_grupo = sum(orden_dosis))
mas_abs <- mas_abs %>% 
  filter(n_grupo == max(n_grupo)) %>% 
  select(grupo_etario)

# mas_rel: en promedio recibió más vacunas
mas_rel <- data %>% 
  group_by(id_persona) %>% 
  filter(fecha_aplicacion == max(fecha_aplicacion)) %>% 
  group_by(grupo_etario) %>% 
  summarise(n_grupo = mean(orden_dosis))
mas_rel <- mas_rel %>% 
  filter(n_grupo == max(n_grupo)) %>% 
  select(grupo_etario)

```
En la base, con fecha de corte hasta `r fecha_i` la población `r mas_abs` recibió mas vacunas en valor absoluto y `r mas_rel` en promedio.

##### By_condicion_aplicacion: Minimo, promedio, maximo, poblacion (n) y participacion (n_relativo) de dosis aplicadas
```{r condicion_min_mean_max_n_nrel}

# data_frame_valores_by_condicion_aplicacion
data %>% 
  group_by(id_persona) %>% 
  filter(fecha_aplicacion == max(fecha_aplicacion)) %>% 
  group_by(condicion_aplicacion) %>% 
  summarise(min_dosis = min(orden_dosis), 
            mean_dosis = mean(orden_dosis), 
            max_dosis = max(orden_dosis),
            n_grupo = length(orden_dosis),
            total_dosis = mean_dosis * n_grupo) %>% 
mutate(n_relativo = n_grupo / sum(n_grupo) * 100 )  %>%
arrange(desc(n_grupo))

# fecha de corte
fecha_i <- summarise(data, max(fecha_aplicacion))

# mas_abs: en absoluto recibió más vacunas
mas_abs <- data %>% 
  group_by(id_persona) %>% 
  filter(fecha_aplicacion == max(fecha_aplicacion)) %>% 
  group_by(condicion_aplicacion) %>% 
  summarise(n_grupo = sum(orden_dosis))
mas_abs <- mas_abs %>% 
  filter(n_grupo == max(n_grupo)) %>% 
  select(condicion_aplicacion)

# mas_rel: en promedio recibió más vacunas
mas_rel <- data %>% 
  group_by(id_persona) %>% 
  filter(fecha_aplicacion == max(fecha_aplicacion)) %>% 
  group_by(condicion_aplicacion) %>% 
  summarise(n_grupo = mean(orden_dosis))
mas_rel <- mas_rel %>% 
  filter(n_grupo == max(n_grupo)) %>% 
  select(condicion_aplicacion)

```
Fecha de corte hasta `r fecha_i` la población `r mas_abs` recibió mas vacunas en valor absoluto y `r mas_rel` en promedio.

##### By_jurisdiccion_aplicacion: Minimo, promedio, maximo, poblacion (n) y participacion (n_relativo) de dosis aplicadas
```{r prov_min_mean_max_n_nrel}

# data_frame_valores_by_condicion_aplicacion
data %>% 
  group_by(id_persona) %>% 
  filter(fecha_aplicacion == max(fecha_aplicacion)) %>% 
  group_by(jurisdiccion_aplicacion) %>% 
  summarise(min_dosis = min(orden_dosis), 
            mean_dosis = mean(orden_dosis), 
            max_dosis = max(orden_dosis),
            n_grupo = length(orden_dosis),
            total_dosis = mean_dosis * n_grupo) %>% 
mutate(n_relativo = n_grupo / sum(n_grupo) * 100 )  %>%
arrange(desc(n_grupo))

# fecha de corte
fecha_i <- summarise(data, max(fecha_aplicacion))

# mas_abs: en absoluto recibió más vacunas
mas_abs <- data %>% 
  group_by(id_persona) %>% 
  filter(fecha_aplicacion == max(fecha_aplicacion)) %>% 
  group_by(jurisdiccion_aplicacion) %>% 
  summarise(n_grupo = sum(orden_dosis))
mas_abs <- mas_abs %>% 
  filter(n_grupo == max(n_grupo)) %>% 
  select(jurisdiccion_aplicacion)

# mas_rel: en promedio recibió más vacunas
mas_rel <- data %>% 
  group_by(id_persona) %>% 
  filter(fecha_aplicacion == max(fecha_aplicacion)) %>% 
  group_by(jurisdiccion_aplicacion) %>% 
  summarise(n_grupo = mean(orden_dosis))
mas_rel <- mas_rel %>% 
  filter(n_grupo == max(n_grupo)) %>% 
  select(jurisdiccion_aplicacion)

```

## Graficos sobre las principales variables

### `sexo`

### `grupo_etario`

### `condicion_aplicacion`

### `jurisdiccion_aplicacion`

## Creo nuevas variables que me sirvan para operar con la fecha

Utilizando la variable fecha como filtro puedo recortar la base para que me traiga la ultima foto disponible para cada persona (justo aquello que no sabia hacer hasta ahora) y puedo analizar:


Siguiendo con el analisis temporal de los datos quisiera saber que cantidad de dosis se aplicaron cada día.
```{r aplicaciones_diarias}
## tabla de aplicaciones diarias
aplicaciones_diarias <- data %>% 
  group_by(fecha_aplicacion) %>% 
  summarise(aplicacion_diaria = n()) %>% 
  arrange(fecha_aplicacion)
print(aplicaciones_diarias)

## variables anio y mes
aplicaciones_diarias <- aplicaciones_diarias %>% 
  mutate(anio = year(fecha_aplicacion),
         mes = month(fecha_aplicacion),
         dia = wday(fecha_aplicacion, label = TRUE, abbr = FALSE))




# reemplazar dias por correcion sin acentos
# levels(factor(aplicaciones_diarias$dia))
# "domingo"      "lunes"        "martes"       "miC\\)rcoles" "jueves"       "viernes"      "sC!bado" 

## variable anio_mes
aplicaciones_diarias <- aplicaciones_diarias %>% 
  mutate(anio_mes = format(fecha_aplicacion, "%Y-%m"))

print(aplicaciones_diarias)
```
***Esta tabla que tiene muchas filas podria verse muy bien en grafico**

```{r personas_por_cant_dosis}
personas_por_dosis <- data %>% 
  group_by(id_persona) %>% 
  filter(fecha_aplicacion == max(fecha_aplicacion)) %>% 
  group_by(orden_dosis, sexo) %>% 
  summarise(pob = n()) %>% 
  arrange(orden_dosis)
print(personas_por_dosis)

hombres_por_dosis <- data %>% 
  group_by(id_persona) %>% 
  filter(fecha_aplicacion == max(fecha_aplicacion)) %>% 
  filter(sexo == "M") %>% 
  group_by(orden_dosis) %>% 
  summarise(M_pob = n()) %>% 
  mutate(M_nrel = M_pob/sum(M_pob)*100) %>% 
  arrange(orden_dosis)
print(hombres_por_dosis)

mujeres_por_dosis <- data %>% 
  group_by(id_persona) %>% 
  filter(fecha_aplicacion == max(fecha_aplicacion)) %>% 
  filter(sexo == "F") %>% 
  group_by(orden_dosis) %>% 
  summarise(F_pob = n()) %>%
  mutate(F_nrel = F_pob/sum(F_pob)*100) %>% 
  arrange(orden_dosis)
print(mujeres_por_dosis)

# Full outer join: combinacion externa es cuando algun codigo identificador no esta disponible en la otra base. 
# En este caso debe agregarse el parametro all = TRUE para que aquellos sin coincidencia en el merge no se eliminen.
sexojoin <- merge(hombres_por_dosis, mujeres_por_dosis, by = "orden_dosis", all = TRUE)
print(sexojoin)

# Reemplazar los valores NA por ceros
sexojoin <- sexojoin %>% mutate_all(~ifelse(is.na(.), 0, .))
sexojoin
#sexojoin <- replace_na(sexojoin, replace = 0)

personas_por_dosis <- personas_por_dosis %>% 
  pivot_wider(names_from = sexo, 
              values_from = pob, 
              values_fill = 0)
print(personas_por_dosis)

personas_por_dosis <- personas_por_dosis %>% 
  group_by(orden_dosis) %>% 
  summarise(pob = F + M + S.I.)

# personas_por_dosis %>% mutate(pobF = colSums(F, na.rm = FALSE),  pobM = colSums(M, na.rm = FALSE), pobSI = colSums(S.I., na.rm = FALSE))
```


:::{.alert .alert-info}
# Analisis por días de la semana
Me gustaria saber si existe alguna tendencia en la cantidad de aplicaciones diarias dependiendo el dia de la semana que toca. Por ejemplo fin de semanas vs dias de semana. O bien, en grafico de barras de dom a lun. aplicaciones promedio u otro valor que no dependa de la magnitud por ejemplo día_i/sumatoria(aplicaciones de la semana) la cual te resulta una participacion de dom[0,1].
1. Debería asociar la fecha con el día.
1. Generar una sumatoria de aplicaciones de la semana y dividir ese día por la sumatoria de la semana. O bien, promedio historico por día.
1. Hacer un grafico boxplot para evaluar visualmente las tendencias de min/media/max de aplicaciones para cada día, por ejemplo separando en 3 periodos el total, incio de la pandemia y escases de vacunas, ASPO fuerte con mas vacunacion y flexibilizacion de ASPO o actualidad. No se armar clusters pero podria ser por ahi armar los rangos de tiempo.
:::

## Quisiera empezar con algunos graficos

```{r}
## deberia empezar con graficos de la ultima foto group_by(id_persona) %>% filter(fecha_aplicacion == max(fecha_aplicacion)) %>% group_by(sexo / edad / condicion / provincia) %>% summarise() %>% arrange()
# 
```


### By_fecha_aplicacion: Aplicaciones diarias para todo el territorio 
```{r}
# Hago una columna de unos.
data <- mutate(data, unos = 1)

# Agrego columna de aplicaciones diaras (sumatoria por dia).
data <- data %>% 
  group_by(fecha_aplicacion) %>% 
  mutate(aplicacion_diaria = length(unos))
```


```{r aplicaciones_diaria}
# Obtengo data frame con aplicaciones por fecha.
data %>% 
  group_by(fecha_aplicacion) %>% 
  summarise(aplicacion_diaria = mean(aplicacion_diaria)) %>% 
  arrange(desc(aplicacion_diaria))

# 
ggplot(data, mapping = aes(x = fecha_aplicacion, fill = vacuna)) +
         geom_bar(stat = "count")
```


# Hipótesis

:::{.alert .alert-info}
Finalmente, esta sección contiene al menos 3 hipótesis o preguntas que puedan ser respondidas a partir de los datos. Éstas tienen que ser más o menos interesantes y no cosas que se hayan respondido con la exploración anterior.

Traten de que sean hipótesis o preguntas que relacionen 2 o más variables. Por ejemplo, “¿Cuál es el mes con más turistas en una región?” no es una pregunta intersante, pero “Existe una relación entre la cantidad de visitas y la cantidad de hoteles en una región” es una hipótesis más jugosa que apunta a la relación entre varias variables y a un fenómeno subyacente que puede tener implicancia y aplicaciones.
:::

Debido a la disponibilidad gradual de dosis de vacunas al comienzo de la pandemia resulta necesario establecer una priorización y ordenamiento de la poblacion objetivo a inmunizar en las primeras rondas con la finalidad de salvaguardar aquellos mas susceptibles, expuestos, vulnerables o de alto riesgo. Para maximizar el cuidado general de la poblacion se cree que mayores de edad, personas con comorbilidades y personal estrategico fueron los priorizados del sistema, teniendo en cuenta que el orden de priorizacion basal es evitar la muerte seguido de evitar enfermar con gravedad.

1. Por esta razón se indagará en las etapas tempranas de vacunacion la incidencia de la poblacion objetivo sobre el total y comparar esos valores con los registrados al finalizar la emergencia mundial cuando la vacuna alcanzo la suficiencia en disponibilidad irrestricta. -> Se indagará sobre las etapas tempranas de vacunacion si las mismas fueron dirigidas a quien se esperaría como poblacion diana bajo la premisa anterior, en qué proporciones y su evolucion.

1. Como segundo criterio ordenador de la estrategia de vacunacion se priorizo las personas que habitan grandes ciudades por la poca distancia que se mantiene y en condiciones de alta densidad demografica. Se puede analizar por departamentos provinciales.

1. Se cree que la poblacion priorizada obtuvo sus dosis de forma mas frecuente que otras poblaciones. Días de descanso entre dosis que tiene en promedio cada poblacion objetivo mediante la fecha de aplicacion de cada registro para cada persona. -> Para eso se calculará la cantidad de dias promedio que pasan entre una dosis y otra. dias_prom_vac1_vac2, dias_prom_vac2_vac3... y un total para dias_prom_vac1_vac99.

1. Se comenzó a flexibilizar la ASPO (AISLAMIENTO SOCIAL PREVENTIVO Y OBLIGATORIO) desde la gran disponibilidad de vacunas a partir del 2022. -> Veremos cuando se registraron picos de vacunacion que permitieron una mayor circulacion libre e irrestricta.

1. Se desea conocer alguna relacion que pueda observarse a traves de los registros sobre jurisdiccion de residencia y de aplicacion. Posiblemente existio un migracion de poblaciones debido al ASPO que puede observarse mediante este cruce o simplemente pueda obtenerse una "foto" de como las personas se mueven de su residencia hasta la aplicacion. Mediante datos espaciales disponibles en INDEC y datos abiertos se puede medir aproximadamente el desplazamiento entre ambos puntos.

1. La distribucion geografica de vacunas se concentró sobre todo en poblaciones con alta densidad demografica y se retardo en alcanzar esas proporciones en las provincias del interior por disponer de mayor espacio para mantener la distancia social o porque las poblaciones envejecidas, de salud y estrategicas se concentran en ciudades grandes que proveen servicios mas complejos.

1. Los mas jovenes registraron menor adherencia a los esquemas de vacunacion que los adultos para todo el periodo en que la disponibilidad es de vacunacion libre sin requisito de etapas. Se cree que los jovenes no confian en la nueva tecnologia de inmunizacion.

## Otras exploraciones posibles

:::{.alert .alert-info}
1. vac_inicia "vacunados con esquema iniciado"
1. vac_completa "vacunados con esquema completo"
1. vac_adiciona "vacunados con dosis adicional"
1. vac_refuerzo "vacunados con un refuerzo"
1. vac_refuerzo2 "vacunados con dos refuerzos"
1. vac_refuerzo3 "vacunados con tres refuerzos"
1. group_by(sexo)
1. group_by(grupo_etario)
1. group_by(condicion_salud)
1. group_by(vacuna)
1. group_by(sexo, grupo_etario)
1. group_by(sexo, grupo_etario, condicion_salud)
1. ver la cantidad de dosis promedio por grupo etario
1. group_by(jurisdiccion_aplicacion/residencia)
1. group_by(fecha_aplicacion)
1. confrontar jurisdiccion_residencia con jurisdiccion_apliacion y sumar los casos [nx3]. eje x residencia eje y aplicacion y ver si existe algun punto muy diferente. Puntos de mayor y menor tamaño (jitter).

Buscar tambien informacion de poblacion por provincia, grupo_etario, sexo para 2023 y asi ver la tasa de cobertura de inmunizacion de personas con 1 o 2 o 3 o mas aplicaciones.
:::

# hacer tabla por grupos: cantidad de dosis, cantidad de personas. pob y pob_rel

# lo mismo para vacunas por marca

