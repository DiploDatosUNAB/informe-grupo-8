---
title: "Aplicacion de vacunas COVID19 en Argentina - NOMIVAC: 2020-2023"
author: "Lautaro Felipe Skubaletzky"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# Cargar los paquetes necesarios acá
library(rmarkdown)
library(readr)
library(dplyr)
library(ggplot2)
library(stringr)
```

# Introducción

:::{.alert .alert-info}
Esta sección consiste en entre 2 y 3 párrafos describiendo los datos. Qué decir sobre los datos dependerá de los datos elegidos pero algunos detalles posibles son:
:::

## ¿Qué datos son?

- Los datos contienen informacion de las aplicaciones de vacunas contra el COVID19.

- A nivel individual, cada fila corresponde a una nueva aplicacion de vacuna.

- Para cada aplicacion disponemos de datos:

  - Desnominalizados del **SUJETO QUIEN** es receptor. *(id_persona_dw)*.

  - Categoricas como **DICOTOMICAS** del sexo y **RANGOS** por grupo etario. *(sexo y grupo_etario)*.

  - ... un score de prioridad **ORDINAL** segun edad y factores de riesgo. *(condicion_aplicacion)*.

  - Informacion temporal del **CUANDO** se aplica. **YYYY-MM-DD.** *(fecha_aplicacion)*.

  - Informacion de departamento y jurisdiccion **DONDE** residence. **GEOREF.** *(jurisdiccion_residencia y depto_residencia)*.

  - Informacion de departamente y jurisdiccion **DONDE** se aplica. **GEOREF.** *(jurisdiccion_aplica y depto_aplica)*

  - ... **QUÉ** vacuna recibe. *(vacuna)*

  - ... **QUÉ** lote descarga esa dosis. *(lote_vacuna)*
  
  - ... **CANTIDAD** de dosis recibidas. *(orden_dosis)*
  
  - ... **ESTADO DE AVANCE** con el esquema. *(nombre_dosis_generica)*

  - ... adicionalmente a estos datos existen otras variables numericas que acompañan a las últimas manteniendo correspondencia entre **Códigos Ids** y **valores-definición.**
  
Para enternder un poco mas sobre los esquemas de vacunación y refuerzos para las diferentes poblaciones, visitar la pagina [sobre la vacunación contra el COVID19.](https://www.argentina.gob.ar/coronavirus/vacuna)

Existe un dataset adicional en relacion a éste que registra los precios en dólares pagados por cada dosis por parte del Ministerio de Salud de la Nación. [**Link**](http://datos.salud.gob.ar/dataset/precio-unitario-de-vacunas-covid-19-adquiridas-por-el-ministerio-de-salud-de-la-nacion)
  

## ¿De dónde provienen? ¿Quién los tomó?

Los datos fueron obtenidos del sitio de datos abiertos de la pagina de la nacion
["datos abiertos argentina."](https://datos.gob.ar/dataset/salud-vacunas-contra-covid-19-dosis-aplicadas-republica-argentina---registro-desagregado){.alert-link}

Los datos son propiedad del **Ministerio de Salud de la Nación, Dirección de Control de Enfermedades Inmunoprevenibles (DiCEI)** quien mantiene actualizado y online el dataset.

Por otro lado, el registro está a cargo del **Programa Nacional de Control de Enfermedades Inmunoprevenibles (ProNaCEI)**, creado por [Resolución Ministerial 776/2010](https://bancos.salud.gob.ar/sites/default/files/2018-10/0000000494cnt-2013-10_resolucion-ministerial-259.pdf), cuyo propósito es disminuir la mortalidad a causa de dichas enfermedades, mediante la vacunación sostenida de los niños y adultos según vacuna y población objeto definida.

## ¿En qué período se tomaron?

Los datos corresponden al periodo que comprende la pandemia del COVID19. 

El registro mas antiguo es del *29/12/2020* que podría corresponder a la aplicación de los primeros lotes de vacunas nacionalizadas o primeros vacunados registrados en el [NOMIVAC - Registro Federal de Vacunación Nominalizado](https://sisa.msal.gov.ar/sisadoc/docs/050203/nomivac_home.jsp). Sin perjuicio de ello, el registro se creó el *23/03/2021* dando apertura a su publicacion en "datos abiertos" a partir de esa fecha.

Según la [pagina web](https://datos.gob.ar/dataset/salud-vacunas-contra-covid-19-dosis-aplicadas-republica-argentina---registro-desagregado/archivo/salud_e4515c25-e1fd-4f02-b1c1-5453c36eada6) en donde se encuentra disponible la base de datos, la frecuencia de actualizacion es a diario.

El registro mas reciente del que se dispone es del *29/04/2023*, fecha en la que se realizó mi descarga y que luego se filtró la base en cantidad de observaciones para poder importarla de manera completa.

# Exploración de los datos

:::{.alert .alert-info}
Esta sección es una primera exploracion de los datos. ¿Qué variables tiene? ¿Cuántas observaciones hay? ¿Cuántas variables?

Seleccioná algunas variables resulten interesantes y mostrá sus propiedades.
:::

Los datos ingresados son tan solo una parte de la base, puesto que los ingredientes no entran todos juntos en la cocina...
La base completa cuenta con 18 variables entre numeros enteros, fechas, palabras, codigos_id, etc. y unas 115 millones de filas. Intenté durante mucho, mucho^2, mucho^mucho, cargar esos datos a RStudio pero siempre fallo la carga vía read_csv, entonces en "/scripts/0_importa-datos.R", limite la cantidad de filas a leer, para poder avanzar con el TP1.

```{r importaDatos, echo=FALSE, warning=FALSE}
# Código para cargar o leer los datos
# render("0_importa-datos.R")
rm(list = ls())
#source("scripts/0_descarga-datos.R")
#source("scripts/0_unzip-datos.R")
source("scripts/0_importa-datos.R", local = TRUE, echo = TRUE)
```

Cödigo de R acá. Agregá más bloques según sea necesario
1. vac_inicia "vacunados con esquema iniciado"
1. vac_completa "vacunados con esquema completo"
1. vac_adiciona "vacunados con dosis adicional"
1. vac_refuerzo "vacunados con un refuerzo"
1. vac_refuerzo2 "vacunados con dos refuerzos"
1. vac_refuerzo3 "vacunados con tres refuerzos"
1. group_by(sexo)
1. group_by(grupo_etario)
1. group_by(condicion_salud)
1. group_by(sexo grupo_etario)
1. group_by(sexo grupo_etario condicion_salud)
1. ver la cantidad de dosis promedio por grupo etario

## Exploracion de dominio (valores unicos en cada variable)

A continuacion exploro cuales son los posibles valores que adoptan las variables, es decir su dominio, en terminos del "estado de la variable".

```{r valoresDeVariables, echo=TRUE, results='hide', eval=FALSE}
levels(factor(data$sexo))
levels(factor(data$grupo_etario))
#levels(factor(data$jurisdiccion_residencia))
#levels(factor(data$depto_residencia))
#levels(factor(data$jurisdiccion_aplicacion))
#levels(factor(data$depto_aplicacion))
#levels(factor(data$fecha_aplicacion))
levels(factor(data$vacuna))
levels(factor(data$nombre_dosis_generica))
levels(factor(data$condicion_aplicacion))
#levels(factor(data$lote_vacuna))
levels(factor(data$orden_dosis))
```


```{r}
data <- data %>% 
  rename(id_persona = id_persona_dw)
```

## Correccion de datos (normalizacion y homogeneizacion)


**grupo_etario (normalización):** Se hallaron diferentes formas de ingresar datos sobre las edades y resulta procedente tenerlos mejor organizados bajo un esquema alfabetico del tipo 0-9/A-Z. A continuacion se modifican datos de grupo_etario según conveniencia.

```{r edit_grupo_etario}
data <- data %>%
  mutate(grupo_etario = case_when(
    grupo_etario == "<12"   ~ "000-012",
    grupo_etario == "12-17" ~ "012-017",
    grupo_etario == "18-29" ~ "018-029",
    grupo_etario == "30-39" ~ "030-039",
    grupo_etario == "40-49" ~ "040-049",
    grupo_etario == "50-59" ~ "050-059",
    grupo_etario == "60-69" ~ "060-069",
    grupo_etario == "70-79" ~ "070-079",
    grupo_etario == "80-89" ~ "080-089",
    grupo_etario == "90-99" ~ "090-099",
    grupo_etario == ">=100" ~ "100-199",
    TRUE ~ grupo_etario
  ))
```
Se han normalizado los strings para mejor ordenamiento del grupo_etario.


**condicion_aplicacion (edición):** Se consideran incorrectos algunos valores del dominio de la variable condicion_aplicacion ya que repite informacion reservada para informarse a traves de la variable de grupo_etario. Esta situacion tambien genera una desagregacion importante en subgrupos de personas con y sin factores de riesgo, desagrupados por edad. Se remueve la informacion de grupo_etario de la variable condicion_aplicacion para que se agrupen un poco más en funcion del concepto.

```{r edit_condicion}
levels(factor(data$condicion_aplicacion))

data <- data %>% 
  mutate(condicion_aplicacion = ifelse(condicion_aplicacion == "60 o más años", "Adulto mayor", condicion_aplicacion))

data <- data %>%
  mutate(condicion_aplicacion = ifelse(str_detect(condicion_aplicacion, "años"), 
                            str_extract(condicion_aplicacion, "(?<=años\\s).*"),
                            condicion_aplicacion))

data <- data %>%
  mutate(condicion_aplicacion = case_when(
    condicion_aplicacion == "Adulto mayor"           ~ "Adulto mayor",
    condicion_aplicacion == "Estratégico"            ~ "Estratégico",
    condicion_aplicacion == "Salud"                  ~ "Salud",
    condicion_aplicacion == "CON Factores de Riesgo" ~ "Factores Riesgo ON",
    condicion_aplicacion == "Embarazo"               ~ "Embarazo",
    condicion_aplicacion == "Viaje"                  ~ "Viaje",
    condicion_aplicacion == "Otros"                  ~ "Otros",
    condicion_aplicacion == "SIN Factores de Riesgo" ~ "Factores Riesgo OFF",
    TRUE ~ condicion_aplicacion
  ))

levels(factor(data$condicion_aplicacion))
```
Se han editado las categorías para simplificar su analisis.


**sexo (agrupacion):** sexo tiene dom{"F","M","S.I.","X"} donde X y S.I. (se asume sin especificar) resultan indistinto para analizar por ende restringimos el dominio => dom{"F","M","S.I."}.

```{r edit_sex}
levels(factor(data$sexo))

data <- data %>% 
  mutate(sexo = ifelse(sexo=="X", "S.I.", sexo))

levels(factor(data$sexo))
```
Se agrupo sexo = "X" con sexo = "S.I.".

## Obtengo algunos df para explorar cantidades y participacion variables de interes y de poblacion objetivo.

Cuantos por genero/edad/condicion tomados por cantidad de dosis tuvieron 1 / 2 / 3... dosis.

```{r sex_obs_part}
data %>% 
  group_by(sexo) %>% 
  summarise(pob = length(sexo)) %>% 
  mutate(participacion_relativa = pob / sum(pob) * 100) %>% 
  arrange(desc(sexo))
```
En la base hay mas mujeres que recibieron vacunas que hombres.

```{r edad_obs_part}
data %>% 
  group_by(grupo_etario) %>% 
  summarise(pob = length(grupo_etario)) %>% ## existe repeticion de personas.
  mutate(participacion_relativa = pob / sum(pob) * 100) %>%
  arrange(desc(grupo_etario))
```
Se observa que quienes mas vacunaciones tienen son el grupo de 18 a 29 años. Esto puede deberse al recorte realizado, o bien que estas personas estan en trabajos estrategicos.

```{r condicion_obs_part}
data %>% 
  group_by(condicion_aplicacion) %>% 
  summarise(pob = length(id_persona)) %>% ## existe repeticion de personas.
  mutate(participacion_relativa = pob / sum(pob) * 100) %>%
  arrange(desc(pob))
```
Se vacunaron mas personas **sin** factores de riesgo que **con** factores de riesgo, lo que en un primer momento puede parecer contraintuitivo. Se produce una confusion por la creencia en que personas con factores de riesgo serían mas prevalentes en la base, pero no es así, ya que no es la categoría de mas personas en la base. Por otro lado, lo que sí es correcto esperarse, es ver la poblacion con factores de riesgo, siendo vacunada con prioridad en las primeras rondas y con mayor cantidad de dosis que otras poblaciones.

**Devenido del analisis anterior:** se aprecia un error en la concepcion de estos datos. La base no fué filtrada por id_personadw por lo tanto existen multiples registros de aplicacion de vacunas para cada persona, en diferentes momentos (se cree). Si hubieramos importado la base completa quedaría en evidencia que existen varios registros (filas) por persona, una fila por cada aplicacion. Ya que importamos solo un recorte de los datos para no colapsar la memoria del ordenador no quedo tan en evidencia que la cantidad de registros (aprox.115millones) no cuadra ni de cerca con la cantidad de habitantes (aprox.45millones).

**Como utilizar la base de forma correcta:** para cada id_persona deberia analizarse en estas descriptivas solamente el ultimo registro alcanzado y aclarar bien definidamente que se considera un intervalo temporal de los registros totales que comienza en t(0) y termina en t(T). Es decir, es necesario filtrar filas para que solo me queden los datos de la ultima "foto" del estado de situacion hasta el momento t(T) de cada persona. "no se como operar eso".

### Minimo, promedio y maximo de dosis aplicadas a cada poblacion objetivo:

```{r sexo_min_mean_max}
data %>% 
  group_by(sexo) %>% 
  summarise(min_dosis = min(orden_dosis), 
            mean_dosis = mean(orden_dosis), 
            max_dosis = max(orden_dosis),
            n_grupo = length(orden_dosis)) %>% 
mutate(n_relativo = n_grupo / sum(n_grupo) * 100 )  %>%
arrange(desc(sexo))
```
Las mujeres en promedio se aplicaron mas vacunas que los hombres y adicionalmente forman un grupo mas numeroso. Mediante otros analisis puede comprobarse si estas medias realmente difieren estadisticamente [link.](https://openstax.org/books/introducci%C3%B3n-estad%C3%ADstica-empresarial/pages/10-1-comparacion-de-las-medias-de-dos-poblaciones-independientes)

```{r edad_min_mean_max}
data %>% 
  group_by(grupo_etario) %>% 
  summarise(min_dosis = min(orden_dosis), 
            mean_dosis = mean(orden_dosis), 
            max_dosis = max(orden_dosis),
            n_grupo = length(grupo_etario)) %>%
mutate(n_relativo = n_grupo / sum(n_grupo) * 100 )  %>%
arrange(desc(mean_dosis))
```
Se puede apreciar que casi todos los grupos etarios tienen un promedio de aplicaciones similar, y los valores extremos de minimos y maximos practicamente iguales.


```{r min_mean_max}
data %>% 
  group_by(condicion_aplicacion) %>% 
  summarise(min_dosis = min(orden_dosis), 
            mean_dosis = mean(orden_dosis), 
            max_dosis = max(orden_dosis),
            n_grupo = length(condicion_aplicacion)) %>% 
  mutate(n_relativo = n_grupo / sum(n_grupo) * 100 )  %>%
  arrange(desc(mean_dosis))
```


## Analisis para el grupo de factores de riesgo, como se compone en genero y edad.

```{r}
data %>% 
  filter(condicion_aplicacion == "Factores Riesgo ON") %>% 
  group_by(grupo_etario) %>% 
  summarise(orden_dosis_mean = mean(orden_dosis),
            pob = length(orden_dosis)) %>% 
  mutate() %>% 
  arrange(desc(pob))
```


## Creo nuevas variables que me sirvan para operar con la fecha

```{r noDupliReg_intento2}
data %>%
  group_by(id_persona) %>% 
  filter(fecha_aplicacion == max(fecha_aplicacion)) %>% 
  group_by(condicion_aplicacion) %>% 
  summarise(dosis_media = mean(orden_dosis),
            pob = length(orden_dosis)) %>% 
  mutate(pob_rel = pob / sum(pob) * 100 ) %>% 
  arrange(dosis_media, pob)
```
la suma de la poblacion me da 811.685 ahora si creo que me estan dando bien los resultados en vistas que tenia el objetivo de solamente analiza un registro por persona, y el registro mas actualizado por fecha. Estos 811 mil / 1000 mil registros importados es la proporcion de registros unicos mientras que 189 mil deben ser registros ya contenidos en la misma base y que son anteriores aplicaciones de vacuna.

Siguiendo con el analisis temporal de los datos quisiera saber que cantidad de dosis se aplicaron cada día.
```{r aplicaciones_diarias}
data %>% 
  group_by(fecha_aplicacion) %>% 
  summarise(aplicacion_diaria = length(id_persona)) %>% 
  arrange(fecha_aplicacion)

## este cuadro tiene potencial para verse bien en grafico.
```

Distribucion de vacunas por provincia de aplicacion
```{r prov_obs_part}
data %>% 
  group_by(jurisdiccion_aplicacion) %>% 
  summarise(pob = length(jurisdiccion_aplicacion)) %>% 
  mutate(pob_rel = pob / sum(pob) * 100 ) %>% 
  arrange(desc(pob))
```
Era de esperar Buenos Aires a la cabeza.

## Quisiera empezar con algunos graficos

por ejemplo: 
```{r}
data <- mutate(data, unos = 1)

ggplot(data, mapping = aes(x = fecha_aplicacion, fill = vacuna)) +
         geom_bar(stat = "sum", mapping = aes(y = unos))
```
[monitor de vacunas covid](https://www.argentina.gob.ar/coronavirus/vacuna/aplicadas)
....


![Poblacion por edades vs dosis detras](https://www.teseopress.com/americalatinaenlatransiciondemografica/wp-content/uploads/sites/1127/2022/03/image36.png)

## Hipótesis

:::{.alert .alert-info}
Finalmente, esta sección contiene al menos 3 hipótesis o preguntas que puedan ser respondidas a partir de los datos. Éstas tienen que ser más o menos interesantes y no cosas que se hayan respondido con la exploración anterior.

Traten de que sean hipótesis o preguntas que relacionen 2 o más variables. Por ejemplo, “¿Cuál es el mes con más turistas en una región?” no es una pregunta intersante, pero “Existe una relación entre la cantidad de visitas y la cantidad de hoteles en una región” es una hipótesis más jugosa que apunta a la relación entre varias variables y a un fenómeno subyacente que puede tener implicancia y aplicaciones.
:::

Debido a la disponibilidad gradual de dosis de vacunas al comienzo de la pandemia resulta necesario establecer una priorización y ordenamiento de la poblacion objetivo a inmunizar en las primeras rondas con la finalidad de salvaguardar aquellos mas susceptibles, vulnerables y expuestos. Para maximizar el cuidado de la gente se cree que mayores de edad, personas con comorbilidades y personal estrategico fueron los priorizados del sistema.

1. Por esta razón se indagará en las etapas tempranas de vacunacion la incidencia de la poblacion objetivo sobre el total y comparar esos valores con los registrados al finalizar la emergencia mundial cuando la vacuna alcanzo la suficiencia en disponibilidad irrestricta. (Se indagará sobre las etapas tempranas de vacunacion si las mismas fueron dirigidas a quien se esperaría como poblacion diana bajo la premisa anterior y en qué proporciones.)

1. Como segundo criterio ordenador de la estrategia de vacunacion se priorizo las personas que habitan grandes ciudades por la poca distancia que se mantiene y en condiciones de alta densidad demografica. Se puede analizar por departamentos provinciales.

1. Se cree que la poblacion diana obtuvo su segunda dosis en menor tiempo que las otras poblaciones. Ademas se intentara exhibir la frecuencia y distancia temporal que se observa entre una dosis y otra (descanso entre dosis que tiene en promedio cada poblacion objetivo mediante la fecha de aplicacion de cada registro para cada persona).

1. Las personas que habitualmente residen grandes ciudades durante el ASPO podría haberse mudado a la periferia por las caracteristicas coyunturales de menor tasa de contagio u trabajo remoto y han sido vacunadas en departamentos que no corresponden a su residencia habitual. Se analiza los focos de aplicaciones para 3 intervalos temporales, inicial - nudo - final, para entreveer si existe movilizacion de habitantes entre las provinvias muy marcado por la ASPO.

1. La distribucion geografica de vacunas se concentró sobre todo en poblaciones con alta densidad demografica y se retardo en alcanzar esas proporciones en las provincias del interior por disponer de mayor espacio para mantener la distancia social.

1. Los mas jovenes registraron menor adherencia a los esquemas de vacunacion que los adultos para todo el periodo en que la disponibilidad es de vacunacion libre sin requisito de etapas. 

```{r}
ggplot2::ggplot(data, aes(x = data$grupo_etario, y = data$sexo)) + coord_flip()
```


:::{.alert .alert-info}

:::
